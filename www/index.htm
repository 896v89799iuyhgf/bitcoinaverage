<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>BitcoinAverage</title>

    <link rel="icon" type="image/png" href="/favicon.png">

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    //config should be moved to server side
        var currencyOrder = ['USD','EUR','GBP','CAD','RUR'];
        var legendSlots = 3;

        var base_host = '';
        var API_host = '';
        var API_all_url = '';
        $(function(){
            var current_host = window.location.host;
            if (current_host == '') {
                current_host = 'dev.bitcoinaverage.com';
            }
            current_host = current_host.split('.');
            base_host = current_host.pop();
            base_host = current_host.pop()+'.'+base_host;
            API_host = 'api.'+base_host;
            API_all_url = 'http://'+API_host+'/all';

//            API_all_url = 'http://api.ba.virtualhost/all';
        });
    </script>
    <script type="text/javascript">
        $(function(){
            callAPI();
            setInterval(callAPI, 5000);

            for(var slotNum in currencyOrder){
                $('#slot'+slotNum+'-last, #slot'+slotNum+'-ask, #slot'+slotNum+'-bid').dblclick(function(event){
                    event.preventDefault();
                    $(this).selectText();
                });

                var slotLegendSelector = $('.slot'+slotNum+'-legend');
                slotLegendSelector.mouseover(function(event){
                    for(var slotNum1 in currencyOrder){
                        $('.slot'+slotNum1+'-box').css({'border':'1px solid #999'});
                        $('.slot'+slotNum1+'-legend').css({'opacity':'1.0'});
                    }
                });
                slotLegendSelector.mouseout(function(event){
                    for(var slotNum1 in currencyOrder){
                        $('.slot'+slotNum1+'-box').css({'border':'1px solid #F0F0F0'});
                        $('.slot'+slotNum1+'-legend').css({'opacity':'0.05'});
                    }
                });

            }
        });


        function callAPI(){
            if (window.XDomainRequest) {
                var xhr = new window.XDomainRequest();
                xhr.open('GET', API_all_url, true);
                xhr.onload = function() {
	                var result = JSON.parse(xhr.responseText);
                    updateAllData(result);
    	        }
                xhr.send();
            } else {
                $.getJSON(API_all_url, updateAllData);
            }
        }

        function updateAllData(result){
                var titleSet = false;

                for(var slotNum in currencyOrder){
                    var currencyCode = currencyOrder[slotNum];

                    updateRates(currencyCode, result[currencyCode], slotNum);
                    updateLegend(currencyCode, result[currencyCode], slotNum);

                    if (!titleSet){
                        titleSet = true;
                        document.title = '$'+result[currencyCode].averages.last+' - BitcoinAverage';
                    }
                }

                $('#ignored-count').text($(result.ignored_exchanges).countObj());

                $('body').show();
        }

        function updateRates(currencyCode, currencyData, slotNum){

            $('#slot'+slotNum+'-curcode').text(currencyCode);
            $('#slot'+slotNum+'-last').text(currencyData.averages.last);
            $('#slot'+slotNum+'-ask').text(currencyData.averages.ask);
            $('#slot'+slotNum+'-bid').text(currencyData.averages.bid);

            var flashingFigures = $('#slot'+slotNum+'-last, #slot'+slotNum+'-ask, #slot'+slotNum+'-bid');
            flashingFigures.css({ 'opacity' : 0.5});
            flashingFigures.animate({ 'opacity' : 1 }, 100);
        }

        function updateLegend(currencyCode, currencyData, slotNum){
            var exchangeArray = [];

            var index = 0;
            for(var exchange_name in currencyData.exchanges){
                currencyData.exchanges[exchange_name]['name'] = exchange_name;
                exchangeArray[index] = currencyData.exchanges[exchange_name];
                index++;
            }
            exchangeArray.sort(function(a, b){
                if(a.volume_percent < b.volume_percent){
                    return 1;
                } else {
                    return -1;
                }
            });


            for(var subslotNum=0;subslotNum<legendSlots;subslotNum++){
                $('#slot'+slotNum+'-subslot'+subslotNum).toggle(false);
            }
            $('#slot'+slotNum+'-subslot-other').toggle(false);

            var otherCount = 0;
            var otherPercent = 0;
            var otherVolume = 0;
            for(var subslotNum in exchangeArray){
                if(subslotNum<legendSlots){
                    $('#slot'+slotNum+'-subslot'+subslotNum+'-name').text(exchangeArray[subslotNum]['name']);
                    $('#slot'+slotNum+'-subslot'+subslotNum+'-volume_btc').text(exchangeArray[subslotNum]['volume_btc']);
                    $('#slot'+slotNum+'-subslot'+subslotNum+'-volume_percent').text(exchangeArray[subslotNum]['volume_percent']);
                    $('#slot'+slotNum+'-subslot'+subslotNum+'-rate').text(exchangeArray[subslotNum]['rates']['last']);
                    $('#slot'+slotNum+'-subslot'+subslotNum).toggle(true);
                } else {
                    otherCount = otherCount+1;
                    otherPercent = otherPercent+exchangeArray[subslotNum]['volume_percent'];
                    otherVolume = otherVolume+exchangeArray[subslotNum]['volume_btc'];
                }
            }
            if(otherCount > 0){
                $('#slot'+slotNum+'-subslot-other').toggle(true);
                $('#slot'+slotNum+'-subslot-other-count').text(otherCount);
                $('#slot'+slotNum+'-subslot-other-volume_btc').text(otherVolume);
                $('#slot'+slotNum+'-subslot-other-volume_percent').text(otherPercent);
            }


        }


        jQuery.fn.selectText = function(){
            var doc = document
                , element = this[0]
                , range, selection
            ;
            if (doc.body.createTextRange) {
                range = document.body.createTextRange();
                range.moveToElementText(element);
                range.select();
            } else if (window.getSelection) {
                selection = window.getSelection();
                range = document.createRange();
                range.selectNodeContents(element);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        };

        jQuery.fn.countObj = function(){
            var count = 0;
            var obj = this[0];
            for (i in obj) {
                if (obj.hasOwnProperty(i)) {
                    count++;
                }
            }
            return count;
        }

    </script>

    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <style type="text/css">
        body {
            background-color: #F5F5F5 ;
            position: relative;
            font-family: 'Open Sans', sans-serif;
        }

        html, body {
            height:100%;
            min-height: 100%
        }

        #header-n-content {
            width: 940px;
            min-height: 100%;
            height: auto !important;
            margin: 0 auto;
            vertical-align: middle;
        }

        #header{
            margin-top: 50px;
            font-size: 1.5em;
            color: #999;
        }
        .beta{
            color: #CCC;
            font-size: 0.8em;
            padding-left: 10px;
        }

        #content {
            position : absolute;
            top:50%;
            margin-top: -100px;
        }

        .slot0-box,.slot1-box,.slot2-box,.slot3-box,.slot4-box{
            border:1px solid #F0F0F0;
            border-radius: 15px;

        }
        .slot0-legend,.slot1-legend,.slot2-legend,.slot3-legend,.slot4-legend{
            opacity: 0.05;
        }

        .slot0-box{
            width: 550px;
            display: inline-block;
            margin-left: 280px;
            padding: 0px 10px 8px 10px;
        }
        .slot0-legend{
            display: inline-block;
            font-size: 0.8em;
            font-weight: normal;
            width: 250px;
            margin: auto 10px ;
            overflow: hidden;
            vertical-align: super;
            line-height: 1.2em;
        }
        .slot0-legend ul li{
            list-style: none outside;
            line-height: 1.2em;
            margin-left: -20px;
        }

        .bid_ask {
            font-size: 1.3em
        }
        .bid_ask-titles {
            color:#999;
        }

        .slot0_values{
            color: #333;
            font-weight: bold;
        }
        .other_values{
            color: #999;
            font-weight: bold;
        }


        #push_footer {
            height: 45px;
        }

        #footer, #push_footer {
            margin: 0 auto;
        }

        #footer {
            height: 25px;
            margin-top: -25px;
            width: 100%;
            color: #999;
        }
    </style>
</head>
<body style="display: none;">

<div id="header-n-content" class="container">
    <div id="header" class="navbar">
        <div class="span3">BitcoinAverage <span class="beta">beta</span></div>
        <div class="span1 pull-right text-right"><a href="http://api.bitcoinaverage.com">API</a></div>
    </div>
    <div id="content">
        <div class="digits">
            <div class="row slot0_values">
                <div class="span10 text-center">
                    <div class="slot0-box text-left">
                        <div style="display: inline-block;">
                            <h1><span id="slot0-last"></span> <span id="slot0-curcode"></span></h1>
                            <span class="bid_ask">
                                <span class="bid_ask-titles">bid &nbsp;</span>
                                <span id="slot0-bid" title="bid"></span>
                                &nbsp;/&nbsp;
                                <span id="slot0-ask" title="ask"></span>
                                <span class="bid_ask-titles">&nbsp ask</span>
                            </span>
                        </div>
                        <div class="slot0-legend text-left">
                            <ul>
                                <li id="slot0-subslot0">
                                    <span id="slot0-subslot0-name"></span>,
                                    <span id="slot0-subslot0-volume_btc"></span> BTC,
                                    <span id="slot0-subslot0-volume_percent"></span>%,
                                    <span id="slot0-subslot0-rate"></span>
                                </li>
                                <li id="slot0-subslot1">
                                    <span id="slot0-subslot1-name"></span>,
                                    <span id="slot0-subslot1-volume_btc"></span> BTC,
                                    <span id="slot0-subslot1-volume_percent"></span>%,
                                    <span id="slot0-subslot1-rate"></span>
                                </li>
                                <li id="slot0-subslot2">
                                    <span id="slot0-subslot2-name"></span>,
                                    <span id="slot0-subslot2-volume_btc"></span> BTC,
                                    <span id="slot0-subslot2-volume_percent"></span>%,
                                    <span id="slot0-subslot2-rate"></span>
                                </li>
                                <li id="slot0-subslot-other">
                                    <span id="slot0-subslot-other-count"></span> more
                                    <span id="slot0-subslot-other-volume_btc"></span> BTC,
                                    <span id="slot0-subslot-other-volume_percent"></span>%,
                                </li>
                                <li><span id="ignored-count"></span> ignored (no API or trading volume data)</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <br>
            <div class="row other_values">
                <div class="span10 text-center">
                    <div class="span1"></div>
                    <div class="span2 slot1-box">
                        <h4><span id="slot1-last"></span> <span id="slot1-curcode"></span></h4>
                        <p> <span id="slot1-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot1-ask" title="ask"></span> </p>

                        <div class="slot1-legend text-left">
                            <ul>
                                <li id="slot1-subslot0">
                                    <span id="slot1-subslot0-name"></span>,
                                    <span id="slot1-subslot0-volume_btc"></span> BTC,
                                    <span id="slot1-subslot0-volume_percent"></span>%,
                                    <span id="slot1-subslot0-rate"></span>
                                </li>
                                <li id="slot1-subslot1">
                                    <span id="slot1-subslot1-name"></span>,
                                    <span id="slot1-subslot1-volume_btc"></span> BTC,
                                    <span id="slot1-subslot1-volume_percent"></span>%,
                                    <span id="slot1-subslot1-rate"></span>
                                </li>
                                <li id="slot1-subslot2">
                                    <span id="slot1-subslot2-name"></span>,
                                    <span id="slot1-subslot2-volume_btc"></span> BTC,
                                    <span id="slot1-subslot2-volume_percent"></span>%,
                                    <span id="slot1-subslot2-rate"></span>
                                </li>
                                <li id="slot1-subslot-other">
                                    <span id="slot1-subslot-other-count"></span> more
                                    <span id="slot1-subslot-other-volume_btc"></span> BTC,
                                    <span id="slot1-subslot-other-volume_percent"></span>%,
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="span2 slot2-box">
                        <h4><span id="slot2-last"></span> <span id="slot2-curcode"></span></h4>
                        <p> <span id="slot2-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot2-ask" title="ask"></span> </p>

                        <div class="slot2-legend text-left">
                            <ul>
                                <li id="slot2-subslot0">
                                    <span id="slot2-subslot0-name"></span>,
                                    <span id="slot2-subslot0-volume_btc"></span> BTC,
                                    <span id="slot2-subslot0-volume_percent"></span>%,
                                    <span id="slot2-subslot0-rate"></span>
                                </li>
                                <li id="slot2-subslot1">
                                    <span id="slot2-subslot1-name"></span>,
                                    <span id="slot2-subslot1-volume_btc"></span> BTC,
                                    <span id="slot2-subslot1-volume_percent"></span>%,
                                    <span id="slot2-subslot1-rate"></span>
                                </li>
                                <li id="slot2-subslot2">
                                    <span id="slot2-subslot2-name"></span>,
                                    <span id="slot2-subslot2-volume_btc"></span> BTC,
                                    <span id="slot2-subslot2-volume_percent"></span>%,
                                    <span id="slot2-subslot2-rate"></span>
                                </li>
                                <li id="slot2-subslot-other">
                                    <span id="slot2-subslot-other-count"></span> more
                                    <span id="slot2-subslot-other-volume_btc"></span> BTC,
                                    <span id="slot2-subslot-other-volume_percent"></span>%,
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="span2 slot3-box">
                        <h4><span id="slot3-last"></span> <span id="slot3-curcode"></span></h4>
                        <p> <span id="slot3-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot3-ask" title="ask"></span> </p>

                        <div class="slot3-legend text-left">
                            <ul>
                                <li id="slot3-subslot0">
                                    <span id="slot3-subslot0-name"></span>,
                                    <span id="slot3-subslot0-volume_btc"></span> BTC,
                                    <span id="slot3-subslot0-volume_percent"></span>%,
                                    <span id="slot3-subslot0-rate"></span>
                                </li>
                                <li id="slot3-subslot1">
                                    <span id="slot3-subslot1-name"></span>,
                                    <span id="slot3-subslot1-volume_btc"></span> BTC,
                                    <span id="slot3-subslot1-volume_percent"></span>%,
                                    <span id="slot3-subslot1-rate"></span>
                                </li>
                                <li id="slot3-subslot2">
                                    <span id="slot3-subslot2-name"></span>,
                                    <span id="slot3-subslot2-volume_btc"></span> BTC,
                                    <span id="slot3-subslot2-volume_percent"></span>%,
                                    <span id="slot3-subslot2-rate"></span>
                                </li>
                                <li id="slot3-subslot-other">
                                    <span id="slot3-subslot-other-count"></span> more
                                    <span id="slot3-subslot-other-volume_btc"></span> BTC,
                                    <span id="slot3-subslot-other-volume_percent"></span>%,
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="span2 slot4-box">
                        <h4><span id="slot4-last"></span> <span id="slot4-curcode"></span></h4>
                        <p> <span id="slot4-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot4-ask" title="ask"></span> </p>

                        <div class="slot4-legend text-left">
                            <ul>
                                <li id="slot4-subslot0">
                                    <span id="slot4-subslot0-name"></span>,
                                    <span id="slot4-subslot0-volume_btc"></span> BTC,
                                    <span id="slot4-subslot0-volume_percent"></span>%,
                                    <span id="slot4-subslot0-rate"></span>
                                </li>
                                <li id="slot4-subslot1">
                                    <span id="slot4-subslot1-name"></span>,
                                    <span id="slot4-subslot1-volume_btc"></span> BTC,
                                    <span id="slot4-subslot1-volume_percent"></span>%,
                                    <span id="slot4-subslot1-rate"></span>
                                </li>
                                <li id="slot4-subslot2">
                                    <span id="slot4-subslot2-name"></span>,
                                    <span id="slot4-subslot2-volume_btc"></span> BTC,
                                    <span id="slot4-subslot2-volume_percent"></span>%,
                                    <span id="slot4-subslot2-rate"></span>
                                </li>
                                <li id="slot4-subslot-other">
                                    <span id="slot4-subslot-other-count"></span> more
                                    <span id="slot4-subslot-other-volume_btc"></span> BTC,
                                    <span id="slot4-subslot-other-volume_percent"></span>%,
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="push_footer"></div>
</div>


<!--<div id="footer">-->
    <!--<footer class="footer">-->
        <!--<div class="text-center">-->
            <!--relative USD volumes:-->
            <!--MTGox <span id="mtgox-weight"></span>,-->
            <!--bitstamp <span id="bitstamp-weight"></span>,-->
            <!--btce <span id="bitstamp-weight"></span>,-->
            <!--bitstamp <span id="bitstamp-weight"></span>-->
        <!--</div>-->
    <!--</footer>-->
<!--</div>-->


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42688472-1', 'bitcoinaverage.com');
ga('send', 'pageview');

</script>
</body>
</html>
