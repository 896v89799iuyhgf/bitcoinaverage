<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <title>BitcoinAverage</title>

    <link rel="icon" href="/favicon.ico" />

    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script type="text/javascript" src="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
    <script type="text/javascript">
    //config should be moved to server side
        var currencyOrder = ['USD','EUR','GBP','CAD','RUB', 'PLN'];
        var legendSlots = 10;
        var API_data = {};

        var base_host = '';
        var API_host = '';
        var API_all_url = '';
        $(function(){
            var current_host = window.location.host;
            if (current_host == '') {
                current_host = 'dev.bitcoinaverage.com';
            }
            current_host = current_host.split('.');
            base_host = current_host.pop();
            base_host = current_host.pop()+'.'+base_host;
            API_host = 'api.'+base_host;
            API_all_url = 'http://'+API_host+'/all';

            if (window.location.host == 'ba.virtualhost') {
                API_all_url = 'http://ba.virtualhost/api/all';
            }
        });
    </script>
    <script type="text/javascript">
        $(function(){
            callAPI();
            setInterval(callAPI, 5000);

            for(var slotNum in currencyOrder){
                $('#slot'+slotNum+'-last, #slot'+slotNum+'-ask, #slot'+slotNum+'-bid').dblclick(function(event){
                    event.preventDefault();
                    $(this).selectText();
                });

                var slotLegendSelector = $('.slot'+slotNum+'-box');
                slotLegendSelector.mouseover(function(event){
                    renderLegend($(this).data('currencycode'));
                    $('#legend-block').show();
                });
                slotLegendSelector.mouseout(function(event){
                    $('#legend-block').hide();
                });

            }
        });


        function callAPI(){
            if (window.XDomainRequest) {
                var xhr = new window.XDomainRequest();
                xhr.open('GET', API_all_url, true);
                xhr.onload = function() {
	                var result = JSON.parse(xhr.responseText);
                    renderAll(result);
    	        }
                xhr.send();
            } else {
                $.getJSON(API_all_url, renderAll);
            }
        }

        function renderAll(result){
                API_data = result;
                var titleSet = false;

                for(var slotNum in currencyOrder){
                    var currencyCode = currencyOrder[slotNum];

                    renderRates(currencyCode, result[currencyCode], slotNum);

                    if (!titleSet){
                        titleSet = true;
                        document.title = '$'+result[currencyCode].averages.last+' - BitcoinAverage';
                    }
                }

                $('#legend-ignored-count').text($(result.ignored_exchanges).countObj());

                $('body').show();
        }

        function renderRates(currencyCode, currencyData, slotNum){
            $('.slot'+slotNum+'-box').data('currencycode', currencyCode);
            $('.slot'+slotNum+'-curcode').text(currencyCode);
            $('#slot'+slotNum+'-last').text(currencyData.averages.last);
            $('#slot'+slotNum+'-ask').text(currencyData.averages.ask);
            $('#slot'+slotNum+'-bid').text(currencyData.averages.bid);

            var flashingFigures = $('#slot'+slotNum+'-last, #slot'+slotNum+'-ask, #slot'+slotNum+'-bid');
            flashingFigures.css({ 'opacity' : 0.5});
            flashingFigures.animate({ 'opacity' : 1 }, 100);
        }

        function renderLegend(currencyCode){
            var exchangeArray = [];
            var currencyData = API_data[currencyCode];

            var index = 0;
            for(var exchange_name in currencyData.exchanges){
                currencyData.exchanges[exchange_name]['name'] = exchange_name;
                exchangeArray[index] = currencyData.exchanges[exchange_name];
                index++;
            }
            exchangeArray.sort(function(a, b){
                if(a.volume_percent < b.volume_percent){
                    return 1;
                } else {
                    return -1;
                }
            });

            $('.legend-curcode').text(currencyCode);


            for(var slotNum=0;slotNum<legendSlots;slotNum++){
                $('#legend-slot'+slotNum).toggle(false);
            }
            $('#legend-other').toggle(false);

            var otherCount = 0;
            var otherPercent = 0;
            var otherVolume = 0;
            for(var slotNum in exchangeArray){
                if(slotNum<legendSlots){
                    $('#legend-slot'+slotNum+'-name').text(exchangeArray[slotNum]['name']);
                    $('#legend-slot'+slotNum+'-volume_btc').text(exchangeArray[slotNum]['volume_btc']);
                    $('#legend-slot'+slotNum+'-volume_percent').text(exchangeArray[slotNum]['volume_percent']);
                    $('#legend-slot'+slotNum+'-rate').text(exchangeArray[slotNum]['rates']['last']);
                    $('#legend-slot'+slotNum).toggle(true);
                } else {
                    otherCount = otherCount+1;
                    otherPercent = otherPercent+exchangeArray[slotNum]['volume_percent'];
                    otherVolume = otherVolume+exchangeArray[slotNum]['volume_btc'];
                }
            }
            if(otherCount > 0){
                $('#slot'+slotNum+'-subslot-other').toggle(true);
                $('#slot'+slotNum+'-subslot-other-count').text(otherCount);
                $('#slot'+slotNum+'-subslot-other-volume_btc').text(otherVolume);
                $('#slot'+slotNum+'-subslot-other-volume_percent').text(otherPercent);
            }


        }


        jQuery.fn.selectText = function(){
            var doc = document
                , element = this[0]
                , range, selection
            ;
            if (doc.body.createTextRange) {
                range = document.body.createTextRange();
                range.moveToElementText(element);
                range.select();
            } else if (window.getSelection) {
                selection = window.getSelection();
                range = document.createRange();
                range.selectNodeContents(element);
                selection.removeAllRanges();
                selection.addRange(range);
            }
        };

        jQuery.fn.countObj = function(){
            var count = 0;
            var obj = this[0];
            for (i in obj) {
                if (obj.hasOwnProperty(i)) {
                    count++;
                }
            }
            return count;
        }

    </script>

    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
    <style type="text/css">
        body {
            background-color: #F5F5F5 ;
            position: relative;
            font-family: 'Open Sans', sans-serif;
        }

        html, body {
            height:100%;
            min-height: 100%
        }

        #header-n-content {
            width: 940px;
            min-height: 100%;
            height: auto !important;
            margin: 0 auto;
            vertical-align: middle;
        }

        #header{
            margin-top: 50px;
            font-size: 1.5em;
            color: #999;
        }
        .beta{
            color: #CCC;
            font-size: 0.8em;
            padding-left: 10px;
        }

        #content {
            position : absolute;
            top:50%;
            margin-top: -100px;
        }
        .slot0-box{
            display: inline-block;
        }

        .bid_ask{font-weight: bold;}
        .slot0-bid_ask{font-size: 1.3em; font-weight: bold;}
        .slot0-bid_ask-titles, .other_values{ color: #999; }

        .legend ul{
            list-style: none outside;
            margin: 0;
        }
        .legend-ignored{
            margin-top: 5px;
        }

        h2{font-size: 1.5em;}

        #legend-block{
            margin-top: 50px;
            border-top: 1px solid #999;
            display: none;
        }

        #push_footer {
            height: 45px;
        }

        #footer, #push_footer {
            margin: 0 auto;
        }

        #footer {
            height: 25px;
            margin-top: -25px;
            width: 100%;
            color: #999;
        }
    </style>
</head>
<body style="display: none;">

<div id="header-n-content" class="container">
    <div id="header" class="navbar">
        <div class="span3">BitcoinAverage <span class="beta">beta</span></div>
        <div class="span1 pull-right text-right"><a href="http://api.bitcoinaverage.com">API</a></div>
    </div>
    <div id="content">
        <div class="digits">
            <div class="row">
                <div class="span10 text-center">
                    <div class="slot0-box" data-currencycode="">
                        <h1><span id="slot0-last"></span> <span class="slot0-curcode"></span></h1>
                        <span class="slot0-bid_ask">
                            <span class="slot0-bid_ask-titles">bid &nbsp;</span>
                            <span id="slot0-bid" title="bid"></span>
                            &nbsp;/&nbsp;
                            <span id="slot0-ask" title="ask"></span>
                            <span class="slot0-bid_ask-titles">&nbsp ask</span>
                        </span>
                    </div>
                </div>
            </div>
            <br>
            <div class="row other_values">
                <div class="span10 text-center">
                    <div class="span2 offset1 slot1-box" data-currencycode="">
                        <h4><span id="slot1-last"></span> <span class="slot1-curcode"></span></h4>
                        <p class="bid_ask"> <span id="slot1-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot1-ask" title="ask"></span> </p>
                    </div>
                    <div class="span2 slot2-box" data-currencycode="">
                        <h4><span id="slot2-last"></span> <span class="slot2-curcode"></span></h4>
                        <p class="bid_ask"> <span id="slot2-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot2-ask" title="ask"></span> </p>
                    </div>
                    <div class="span2 slot3-box" data-currencycode="">
                        <h4><span id="slot3-last"></span> <span class="slot3-curcode"></span></h4>
                        <p class="bid_ask"> <span id="slot3-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot3-ask" title="ask"></span> </p>
                    </div>
                    <div class="span2 slot4-box" data-currencycode="">
                        <h4><span id="slot4-last"></span> <span class="slot4-curcode"></span></h4>
                        <p class="bid_ask"> <span id="slot4-bid" title="bid"></span>&nbsp;/&nbsp;<span id="slot4-ask" title="ask"></span> </p>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="offset2 span6" id="legend-block">
                    <div class="">
                        <h2>data sources for <span class="legend-curcode"></span> weighted average</h2>
                    </div>

                    <div class="legend text-left">
                        <ul>
                            <li id="legend-slot0">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot0-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot0-volume_percent"></span>%</div>
                                    <div class="span2 legend-volume_btc">(&#3647; <span id="legend-slot0-volume_btc"></span>)</div>
                                    <div class="span2 legend-rate text-right">at rate <span id="legend-slot0-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot1">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot1-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot1-volume_percent"></span>%</div>
                                    <div class="span2 legend-volume_btc">(&#3647; <span id="legend-slot1-volume_btc"></span>)</div>
                                    <div class="span2 legend-rate text-right">at rate <span id="legend-slot1-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot2">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot2-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot2-volume_percent"></span>%</div>
                                    <div class="span2 legend-volume_btc">(&#3647; <span id="legend-slot2-volume_btc"></span>)</div>
                                    <div class="span2 legend-rate text-right">at rate <span id="legend-slot2-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot3">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot3-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot3-volume_percent"></span>%</div>
                                    <div class="span2 legend-volume_btc">(&#3647; <span id="legend-slot3-volume_btc"></span>)</div>
                                    <div class="span2 legend-rate text-right">at rate <span id="legend-slot3-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot4">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot4-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot4-volume_percent"></span>%</div>
                                    <div class="span3 legend-volume_btc">(&#3647; <span id="legend-slot4-volume_btc"></span>)</div>
                                    <div class="span3 legend-rate text-right">at rate <span id="legend-slot4-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot5">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot5-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot5-volume_percent"></span>%</div>
                                    <div class="span3 legend-volume_btc">(&#3647; <span id="legend-slot5-volume_btc"></span>)</div>
                                    <div class="span3 legend-rate text-right">at rate <span id="legend-slot5-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot6">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot6-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot6-volume_percent"></span>%</div>
                                    <div class="span3 legend-volume_btc">(&#3647; <span id="legend-slot6-volume_btc"></span>)</div>
                                    <div class="span3 legend-rate text-right">at rate <span id="legend-slot6-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot7">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot7-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot7-volume_percent"></span>%</div>
                                    <div class="span3 legend-volume_btc">(&#3647; <span id="legend-slot7-volume_btc"></span>)</div>
                                    <div class="span3 legend-rate text-right">at rate <span id="legend-slot7-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot8">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot8-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot8-volume_percent"></span>%</div>
                                    <div class="span3 legend-volume_btc">(&#3647; <span id="legend-slot8-volume_btc"></span>)</div>
                                    <div class="span3 legend-rate text-right">at rate <span id="legend-slot8-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <li id="legend-slot9">
                                <div class="row">
                                    <div class="span1 legend-name"><span id="legend-slot9-name"></span></div>
                                    <div class="span1 legend-volume_percent text-right"><span id="legend-slot9-volume_percent"></span>%</div>
                                    <div class="span3 legend-volume_btc">(&#3647; <span id="legend-slot9-volume_btc"></span>)</div>
                                    <div class="span3 legend-rate text-right">at rate <span id="legend-slot9-rate"></span> <span class="legend-curcode"></span></div>
                                </div>
                            </li>
                            <!--<li>-->
                                <!--<div class="span4 offset2 legend-ignored">-->
                                    <!--<span id="legend-ignored-count"></span> ignored (no API or trading volume data)-->
                                <!--</div>-->
                            <!--</li>-->
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div id="push_footer"></div>
</div>


<!--<div id="footer">-->
    <!--<footer class="footer">-->
        <!--<div class="text-center">-->
            <!--relative USD volumes:-->
            <!--MTGox <span id="mtgox-weight"></span>,-->
            <!--bitstamp <span id="bitstamp-weight"></span>,-->
            <!--btce <span id="bitstamp-weight"></span>,-->
            <!--bitstamp <span id="bitstamp-weight"></span>-->
        <!--</div>-->
    <!--</footer>-->
<!--</div>-->


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-42688472-1', 'bitcoinaverage.com');
ga('send', 'pageview');

</script>
</body>
</html>
